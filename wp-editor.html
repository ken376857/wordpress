<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WordPress 自動下書き保存エディター</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f1f1f1;
            padding: 20px;
        }
        
        .editor-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .editor-header {
            background: #0073aa;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .editor-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .save-status {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .editor-content {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        #title {
            width: 100%;
            padding: 12px;
            font-size: 24px;
            font-weight: 600;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fff;
            transition: border-color 0.3s ease;
        }
        
        #title:focus {
            outline: none;
            border-color: #0073aa;
            box-shadow: 0 0 0 2px rgba(0, 115, 170, 0.2);
        }
        
        #content {
            width: 100%;
            min-height: 400px;
            padding: 15px;
            font-size: 16px;
            line-height: 1.6;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
            transition: border-color 0.3s ease;
        }
        
        #content:focus {
            outline: none;
            border-color: #0073aa;
            box-shadow: 0 0 0 2px rgba(0, 115, 170, 0.2);
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        
        .btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            background: #f0f0f0;
            border-color: #ccc;
        }
        
        .btn-primary {
            background: #0073aa;
            color: white;
            border-color: #0073aa;
        }
        
        .btn-primary:hover {
            background: #005a87;
            border-color: #005a87;
        }
        
        .auto-save-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 9999;
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        
        .auto-save-status.success {
            background: #4caf50;
            color: white;
        }
        
        .auto-save-status.error {
            background: #f44336;
            color: white;
        }
        
        .meta-info {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            font-size: 14px;
            color: #666;
        }
        
        .typing-indicator {
            display: inline-block;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .typing-indicator.active {
            opacity: 1;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        
        .typing-indicator::after {
            content: '入力中...';
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="editor-container">
        <div class="editor-header">
            <div class="editor-title">
                WordPress エディター
                <span class="typing-indicator" id="typingIndicator"></span>
            </div>
            <div class="save-status" id="saveStatus">自動保存有効</div>
        </div>
        
        <div class="editor-content">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="manualSave()">手動保存</button>
                <button class="btn" onclick="loadDraft()">下書きを復元</button>
                <button class="btn" onclick="clearContent()">クリア</button>
                <button class="btn" onclick="exportContent()">エクスポート</button>
            </div>
            
            <div class="form-group">
                <label for="title">タイトル</label>
                <input type="text" id="title" placeholder="記事のタイトルを入力してください..." />
            </div>
            
            <div class="form-group">
                <label for="content">本文</label>
                <textarea id="content" placeholder="ここに記事の内容を書いてください...

このエディターは自動的に下書きを保存します：
• 30秒ごとに自動保存
• 入力停止後に即座に保存
• ページを離れる前に保存
• セッション情報で下書きを管理"></textarea>
            </div>
            
            <div class="meta-info">
                <strong>自動保存について：</strong>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>入力内容は30秒ごとに自動的に保存されます</li>
                    <li>タイピング中は保存を一時停止し、入力停止後に保存します</li>
                    <li>ページを離れる際も自動的に保存されます</li>
                    <li>保存状況は右上に表示されます</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="auto-save.js"></script>
    <script>
        let autoSaveInstance;
        let typingTimer;
        
        document.addEventListener('DOMContentLoaded', function() {
            const mockConfig = {
                ajaxUrl: '/mock-save-endpoint',
                nonce: 'mock-nonce-' + Date.now(),
                postId: 0,
                interval: 30000
            };
            
            autoSaveInstance = new AutoSave({
                endpoint: mockConfig.ajaxUrl,
                nonce: mockConfig.nonce,
                postId: mockConfig.postId,
                interval: mockConfig.interval
            });
            
            setupTypingIndicator();
            setupMockBackend();
        });
        
        function setupTypingIndicator() {
            const titleField = document.getElementById('title');
            const contentField = document.getElementById('content');
            const typingIndicator = document.getElementById('typingIndicator');
            
            function showTyping() {
                typingIndicator.classList.add('active');
                clearTimeout(typingTimer);
                
                typingTimer = setTimeout(() => {
                    typingIndicator.classList.remove('active');
                }, 1000);
            }
            
            titleField.addEventListener('input', showTyping);
            contentField.addEventListener('input', showTyping);
        }
        
        function setupMockBackend() {
            const originalFetch = window.fetch;
            window.fetch = function(url, options) {
                if (url.includes('/mock-save-endpoint')) {
                    return new Promise((resolve) => {
                        setTimeout(() => {
                            const formData = new URLSearchParams(options.body);
                            const title = formData.get('title');
                            const content = formData.get('content');
                            
                            localStorage.setItem('wp_draft_title', title);
                            localStorage.setItem('wp_draft_content', content);
                            localStorage.setItem('wp_draft_timestamp', new Date().toLocaleString('ja-JP'));
                            
                            resolve({
                                json: () => Promise.resolve({
                                    success: true,
                                    data: {
                                        message: '下書きが保存されました',
                                        post_id: Math.floor(Math.random() * 1000) + 1,
                                        timestamp: new Date().toISOString()
                                    }
                                })
                            });
                        }, 500);
                    });
                }
                return originalFetch.apply(this, arguments);
            };
        }
        
        function manualSave() {
            if (autoSaveInstance) {
                autoSaveInstance.saveNow();
            }
        }
        
        function loadDraft() {
            const savedTitle = localStorage.getItem('wp_draft_title');
            const savedContent = localStorage.getItem('wp_draft_content');
            const timestamp = localStorage.getItem('wp_draft_timestamp');
            
            if (savedTitle || savedContent) {
                const confirmation = confirm(`保存された下書きが見つかりました。\n保存日時: ${timestamp}\n\n復元しますか？`);
                
                if (confirmation) {
                    document.getElementById('title').value = savedTitle || '';
                    document.getElementById('content').value = savedContent || '';
                    
                    const statusElement = document.getElementById('auto-save-status') || document.createElement('div');
                    statusElement.id = 'auto-save-status';
                    statusElement.className = 'auto-save-status success';
                    statusElement.textContent = '下書きが復元されました';
                    statusElement.style.opacity = '1';
                    
                    if (!document.getElementById('auto-save-status')) {
                        document.body.appendChild(statusElement);
                    }
                    
                    setTimeout(() => {
                        statusElement.style.opacity = '0';
                    }, 3000);
                }
            } else {
                alert('保存された下書きがありません。');
            }
        }
        
        function clearContent() {
            const confirmation = confirm('内容をクリアしますか？\n\n※現在の内容は失われます。');
            
            if (confirmation) {
                document.getElementById('title').value = '';
                document.getElementById('content').value = '';
                localStorage.removeItem('wp_draft_title');
                localStorage.removeItem('wp_draft_content');
                localStorage.removeItem('wp_draft_timestamp');
            }
        }
        
        function exportContent() {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            if (!title && !content) {
                alert('エクスポートする内容がありません。');
                return;
            }
            
            const exportData = {
                title: title,
                content: content,
                timestamp: new Date().toISOString(),
                exported_at: new Date().toLocaleString('ja-JP')
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {
                type: 'application/json'
            });
            
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wp-draft-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        window.addEventListener('beforeunload', function(e) {
            const title = document.getElementById('title').value;
            const content = document.getElementById('content').value;
            
            if (title || content) {
                e.preventDefault();
                e.returnValue = '';
                return '';
            }
        });
    </script>
</body>
</html>